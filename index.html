<html>
<head>
  <title>Mycodo Stats</title>
  <style type="text/css">
    table td, th {
      padding: 0.2em 0.3em;
    }
  </style>
  <script language="JavaScript" type="text/javascript">
    function sort(type)
    {
      document.sorttypeform.sorttype.value = type ;
      document.sorttypeform.submit() ;
    }
    function time(type)
    {
      document.sorttypeform.timeframe.value = type ;
      document.sorttypeform.submit() ;
    }
  </script>
  <style>
    td {
        font-size: 0.8em;
    }
  </style>
  <link rel="stylesheet" href="/static/jquery-jvectormap-2.0.3.css" type="text/css" media="screen"/>
  <script src="/static/jquery-3.0.0.min.js"></script>
  <script src="/static/highmaps.js"></script>
  <script src="/static/world.js"></script>
</head>
<body>

<form name="sorttypeform" method="post" action="/">
<input type="hidden" id="timeframe" name="timeframe" value="{{timeframe}}" />
{%- if timeframe == '365' %}1y {% else -%}<a href="javascript:time('365')">1y</a> {% endif -%}
{%- if timeframe == '182' %}6m {% else -%}<a href="javascript:time('182')">6m</a> {% endif -%}
{%- if timeframe == '30' %}1m {% else -%}<a href="javascript:time('30')">1m</a> {% endif -%}
{%- if timeframe == '10' %}10d {% else -%}<a href="javascript:time('10')">10d</a> {% endif -%}
{%- if timeframe == '3' %}3d {% else -%}<a href="javascript:time('3')">3d</a> {% endif -%}

<input type="hidden" id="sorttype" name="sorttype" value="{{sort_type}}"/>
<table style="font-family:Consolas, monospace">
  <tr>
    <th>#</th>
    <th>{%- if sort_type == 'id' -%}ID{%- else -%}<a href="javascript:sort('id')">ID</a>{%- endif -%}</th>
    <th>Last</th>
    <th>{%- if sort_type == 'Mycodo_revision' -%}M Ver.{%- else -%}<a href="javascript:sort('Mycodo_revision')">M Ver.</a>{%- endif -%}</th>
    <th>{%- if sort_type == 'alembic_version' -%}A Ver.{%- else -%}<a href="javascript:sort('alembic_version')">A Ver.</a>{%- endif -%}</th>
    <th>{%- if sort_type == 'RPi_revision' -%}Pi{%- else -%}<a href="javascript:sort('RPi_revision')">Pi</a>{%- endif -%}</th>
    <th>{%- if sort_type == 'country' -%}Loc{%- else -%}<a href="javascript:sort('country')">Loc</a>{%- endif -%}</th>
    <th>{%- if sort_type == 'daemon_sartup_seconds' -%}Start{%- else -%}<a href="javascript:sort('daemon_sartup_seconds')">Start</a>{%- endif -%}</th>
    <th>{%- if sort_type == 'ram_use_mb' -%}Ram{%- else -%}<a href="javascript:sort('ram_use_mb')">Ram</a>{%- endif -%}</th>
    <th>{%- if sort_type == 'num_users_guest' -%}Gst{%- else -%}<a href="javascript:sort('num_users_guest')">Gst</a>{%- endif -%}</th>
    <th>{%- if sort_type == 'num_users_admin' -%}Adm{%- else -%}<a href="javascript:sort('num_users_admin')">Adm</a>{%- endif -%}</th>
    <th>{%- if sort_type == 'num_relays' -%}Relay{%- else -%}<a href="javascript:sort('num_relays')">Relay</a>{%- endif -%}</th>
    <th>{%- if sort_type == 'num_sensors' -%}Sensor{%- else -%}<a href="javascript:sort('num_sensors')">Sensor</a>{%- endif -%}</th>
    <th>{%- if sort_type == 'num_timers' -%}Timer{%- else -%}<a href="javascript:sort('num_timers')">Timer</a>{%- endif -%}</th>
    <th>{%- if sort_type == 'num_methods' -%}Meth{%- else -%}<a href="javascript:sort('num_methods')">Meth</a>{%- endif -%}</th>
    <th>{%- if sort_type == 'num_pids' -%}PID{%- else -%}<a href="javascript:sort('num_pids')">PID</a>{%- endif -%}</th>
    <th>{%- if sort_type == 'num_LCDs' -%}LCD{%- else -%}<a href="javascript:sort('num_LCDs')">LCD</a>{%- endif -%}</th>
    <th>{%- if sort_type == 'next_send' -%}Next{%- else -%}<a href="javascript:sort('next_send')">Next</a>{%- endif -%}</th>
  </tr>
  {%- for each_id, each_category in ids.iteritems() -%}
    <tr>
      <td>
        {{loop.index}}
      </td>
      <td>
        <a href="/id/{{each_id}}">
        {%- for id, own_host in own_ids.iteritems() if id == each_id -%}
          {{own_host}}
        {%- else -%}
          {{each_id}}
        {%- endfor -%}
        </a>
      </td>
      <td style="white-space: nowrap;">
        {%- for series in stats_data.series if series.tags.anonymous_id == each_id -%}
          {%- if series.name == 'country' -%}
            {%- for key, value in series.iteritems() if key == 'values' -%}
              {{value[0][0]|datetime}}
            {%- endfor -%}
          {%- endif -%}
        {%- endfor -%}
      </td>
      <td>
        {%- for series in stats_data.series if series.tags.anonymous_id == each_id -%}
          {%- if series.name == 'Mycodo_revision' -%}
            {%- for key, value in series.iteritems() if key == 'values' -%}
              {{value[0][1]}}
            {%- endfor -%}
          {%- endif -%}
        {%- endfor -%}
      </td>
       <td>
        {%- for series in stats_data.series if series.tags.anonymous_id == each_id -%}
          {%- if series.name == 'alembic_version' -%}
            {%- for key, value in series.iteritems() if key == 'values' -%}
              {{value[0][1]}}
            {%- endfor -%}
          {%- endif -%}
        {%- endfor -%}
      </td>
      <td>
        {%- for series in stats_data.series if series.tags.anonymous_id == each_id -%}
          {%- if series.name == 'RPi_revision' -%}
            {%- for key, value in series.iteritems() if key == 'values' -%}
              {%- for revision, pi_model in pi_versions.iteritems() if revision == value[0][1] -%}
                {{pi_model}}
              {%- else -%}
                {{value[0][1]}}
              {%- endfor -%}
            {%- endfor -%}
          {%- endif -%}
        {%- endfor -%}
      </td>
      <td>
        {%- for series in stats_data.series if series.tags.anonymous_id == each_id -%}
          {%- if series.name == 'country' -%}
            {%- for key, value in series.iteritems() if key == 'values' -%}
              {{value[0][1]}}
            {%- endfor -%}
          {%- endif -%}
        {%- endfor -%}
      </td>
      <td>
        {%- for series in stats_data.series if series.tags.anonymous_id == each_id -%}
          {%- if series.name == 'daemon_startup_seconds' -%}
            {%- for key, value in series.iteritems() if key == 'values' -%}
              {{value[0][1]|float|round(1)}} 
            {%- endfor -%}
          {%- endif -%}
        {%- endfor -%}
      </td>
      <td>
        {%- for series in stats_data.series if series.tags.anonymous_id == each_id -%}
          {%- if series.name == 'ram_use_mb' -%}
            {%- for key, value in series.iteritems() if key == 'values' -%}
              {{value[0][1]|float|round(1)}}
            {%- endfor -%}
          {%- endif -%}
        {%- endfor -%}
      </td>
      <td>
        {%- for series in stats_data.series if series.tags.anonymous_id == each_id -%}
          {%- if series.name == 'num_users_guest' -%}
            {%- for key, value in series.iteritems() if key == 'values' -%}
              {{value[0][1]}}
            {%- endfor -%}
          {%- endif -%}
        {%- endfor -%}
      </td>
      <td>
        {%- for series in stats_data.series if series.tags.anonymous_id == each_id -%}
          {%- if series.name == 'num_users_admin' -%}
            {%- for key, value in series.iteritems() if key == 'values' -%}
              {{value[0][1]}}
            {%- endfor -%}
          {%- endif -%}
        {%- endfor -%}
      </td>
      <td>
        {%- for series in stats_data.series if series.tags.anonymous_id == each_id -%}
          {%- if series.name == 'num_relays' -%}
            {%- for key, value in series.iteritems() if key == 'values' -%}
              {{value[0][1]}}
            {%- endfor -%}
          {%- endif -%}
        {%- endfor -%}
      </td>
      <td>
        {%- for series in stats_data.series if series.tags.anonymous_id == each_id -%}
          {%- if series.name == 'num_sensors_active' -%}
            {%- for key, value in series.iteritems() if key == 'values' -%}
              {{value[0][1]}}
            {%- endfor -%}
          {%- endif -%}
        {%- endfor -%}
        /
        {%- for series in stats_data.series if series.tags.anonymous_id == each_id -%}
          {%- if series.name == 'num_sensors' -%}
            {%- for key, value in series.iteritems() if key == 'values' -%}
              {{value[0][1]}}
            {%- endfor -%}
          {%- endif -%}
        {%- endfor -%}
      </td>
      <td>
        {%- for series in stats_data.series if series.tags.anonymous_id == each_id -%}
          {%- if series.name == 'num_timers_active' -%}
            {%- for key, value in series.iteritems() if key == 'values' -%}
              {{value[0][1]}}
            {%- endfor -%}
          {%- endif -%}
        {%- endfor -%}
        /
        {%- for series in stats_data.series if series.tags.anonymous_id == each_id -%}
          {%- if series.name == 'num_timers' -%}
            {%- for key, value in series.iteritems() if key == 'values' -%}
              {{value[0][1]}}
            {%- endfor -%}
          {%- endif -%}
        {%- endfor -%}
      </td>
      <td>
        {%- for series in stats_data.series if series.tags.anonymous_id == each_id -%}
          {%- if series.name == 'num_methods_in_pid' -%}
            {%- for key, value in series.iteritems() if key == 'values' -%}
              {{value[0][1]}}
            {%- endfor -%}
          {%- endif -%}
        {%- endfor -%}
        /
        {%- for series in stats_data.series if series.tags.anonymous_id == each_id -%}
          {%- if series.name == 'num_methods' -%}
            {%- for key, value in series.iteritems() if key == 'values' -%}
              {{value[0][1]}}
            {%- endfor -%}
          {%- endif -%}
        {%- endfor -%}
      </td>
      <td>
        {%- for series in stats_data.series if series.tags.anonymous_id == each_id -%}
          {%- if series.name == 'num_pids_active' -%}
            {%- for key, value in series.iteritems() if key == 'values' -%}
              {{value[0][1]}}
            {%- endfor -%}
          {%- endif -%}
        {%- endfor -%}
        /
        {%- for series in stats_data.series if series.tags.anonymous_id == each_id -%}
          {%- if series.name == 'num_pids' -%}
            {%- for key, value in series.iteritems() if key == 'values' -%}
              {{value[0][1]}}
            {%- endfor -%}
          {%- endif -%}
        {%- endfor -%}
      </td>
      <td>
        {%- for series in stats_data.series if series.tags.anonymous_id == each_id -%}
          {%- if series.name == 'num_lcds_active' -%}
            {%- for key, value in series.iteritems() if key == 'values' -%}
              {{value[0][1]}}
            {%- endfor -%}
          {%- endif -%}
        {%- endfor -%}
        /
        {%- for series in stats_data.series if series.tags.anonymous_id == each_id -%}
          {%- if series.name == 'num_lcds' -%}
            {%- for key, value in series.iteritems() if key == 'values' -%}
              {{value[0][1]}}
            {%- endfor -%}
          {%- endif -%}
        {%- endfor -%}
      </td>
      <td>
      {%- for series in stats_data.series if series.tags.anonymous_id == each_id -%}
        {%- if series.name == 'next_send' -%}
          {%- for key, value in series.iteritems() if key == 'values' -%}
            {{value[0][1]|int}}
          {%- endfor -%}
        {%- endif -%}
      {%- endfor -%}
      </td>
    </tr>
  {%- endfor -%}
  
</table>
</form>

  <div id="container"></div>

  <script>
    var countryData = {
      {%- for key, value in countries_count.iteritems() %}
      "{{ key }}": {{ value }}{%- if not loop.last -%},{%- endif -%}
      {% endfor %}
    };

   $(function () {
      $('#container').highcharts('Map', {
        title: {
          text: null
        },

        mapNavigation: {
          enabled: true
        },

        colorAxis: {
          min: 0,
          stops: [
            [0, '#EFEFFF'],
            [0.5, Highcharts.getOptions().colors[0]],
            [1, Highcharts.Color(Highcharts.getOptions().colors[0]).brighten(-0.5).get()]
          ]
        },

        chart: {
          borderWidth: 0
        },

        legend: {
          layout: 'vertical',
          align: 'left',
          verticalAlign: 'bottom'
        },

        credits: {
          enabled: false,
        },

        series: [{
          allAreas: true,
          mapData: Highcharts.maps['custom/world'],
          showInLegend: false,
          data: [
            {%- for code, value in countries_count.iteritems() -%}
            {
              code: '{{code}}',
              value: {{value}}
            }{%- if not loop.last -%},{%- endif -%}
            {% endfor %}
          ],
          states: {
            hover: {
              color: Highcharts.getOptions().colors[2]
            }
          },
          joinBy: ['iso-a2', 'code']
        }]
      });
    });
  </script>

</body>
</html>
